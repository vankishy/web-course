name: SonarCloud Analysis

on:
  # Memicu workflow ini setiap kali ada push ke branch 'main'
  push:
    branches:
      - main  # GANTI INI jika branch utama Anda namanya 'master'
  # Juga memicu saat ada Pull Request
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest # Menggunakan server Ubuntu virtual

    steps:
      # 1. Mengambil kode Anda dari GitHub
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 0 berarti ambil semua riwayat (penting untuk SonarCloud)

      # 2. Menyiapkan lingkungan PHP
      - name: Setup PHP with Xdebug
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4' # Pastikan versi ini sesuai dengan versi Sail Anda
          extensions: dom, curl, libxml, mbstring, zip, pdo, pdo_mysql, bcmath
          coverage: xdebug # Ini akan mengaktifkan driver coverage

      # 3. Menyiapkan Laravel untuk tes
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Generate app key
        run: php artisan key:generate

      # 4. Menjalankan Tes & Membuat Laporan Coverage
      - name: Run Tests and Generate Coverage
        run: php artisan test --coverage-clover build/logs/clover.xml

      # 5. Menjalankan Analisis SonarCloud
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Token bawaan GitHub
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}   # Token yang sudah disimpan pemilik
        with:
          args: >
            -Dsonar.projectKey=vankishy_web-course
            -Dsonar.organization=vankishy
            -Dsonar.sources=app
            -Dsonar.tests=tests
            -Dsonar.php.coverage.reportPaths=build/logs/clover.xml